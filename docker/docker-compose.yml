
services:
  llm_summarizer:
    build: ../src/llm_summarizer
    container_name: llm_summarizer
    depends_on: [mcp_server]
    environment:
      MCP_URL: http://mcp_server:8080
      GROQ_BASE: https://api.groq.com/openai/v1
      GROQ_API_KEY: ${GROQ_API_KEY}
      GROQ_MODEL: llama-3.3-70b-versatile   # or: llama-3.1-8b-instant, mixtral-8x7b-32768, gemma2-9b-it
    ports:
      - "8096:8080"

  mcp_server:
    build: ../src/mcp_server
    container_name: mcp_server
    depends_on: [audit_api]
    environment:
      AUDIT_API_URL: http://audit_api:8080
    ports:
      - "8095:8080"

  dashboard:
    build: ../src/dashboard
    container_name: dashboard
    environment:
      AUDIT_API_URL: http://audit_api:8080
      DASH_REFRESH_SEC: "5"
      # PG_DSN: postgresql+psycopg2://user:pass@postgres:5432/mlflow_db   # optional: enables per-event panel
    depends_on:
      - audit_api
    ports:
      - "8501:8501"
  audit_api:
    build: ../src/audit
    container_name: audit_api
    depends_on: [postgres]
    environment:
      AUDIT_API_URL: http://audit_api:8090
      DASH_REFRESH_SEC: "5"
      PG_DSN: postgresql+psycopg2://user:pass@postgres:5432/mlflow_db
      ROUTER_HEALTH_URL: http://router:7000/health
      MODEL_PING_URL:    http://model_server:6000/ping
    ports: ["8090:8080"]

  retrainer:
    build: ../src/retrainer
    container_name: retrainer
    depends_on:
      - postgres
      - mlflow
      - router
    environment:
      MLFLOW_TRACKING_URI: http://mlflow_server:5000
      MLFLOW_REGISTRY_URI: http://mlflow_server:5000
      MODEL_NAME: event_classifier
      PROMOTE_ALIAS: staging
      PROMOTE_IF_BETTER: "1"
      PG_DSN: postgresql+psycopg2://user:pass@postgres:5432/mlflow_db
      TRAIN_WINDOW_MIN: "60"
      MIN_ROWS_TO_TRAIN: "2000"
      RETRAIN_INTERVAL_S: "1800"

      ROUTER_RELOAD_URL: http://router:7000/reload

  rl_decider:
    build: ../src/rl
    container_name: rl_decider
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow_server:5000
      - RL_POLICY_URI=runs:/23a1f0b5b15b4d708eb0257adfef1190/rl_policy/policy.zip
    depends_on:
      - mlflow
    ports:
      - "8085:8080"   # external if you want to poke it
  feature_orchestrator:
    build: ../src/feature_orchestrator
    container_name: feature_orchestrator
    depends_on:
      - kafka
      - postgres
      - redis
      - mlflow
      - router_worker   # ensures events_scored gets populated
    environment:
      # Brokers & topics
      KAFKA_BROKERS: kafka:9092
      IN_TOPIC: events.low_latency
      OUT_TOPIC: features.computed
      GROUP_ID: feature_orchestrator_v1
      # Conditional policy
      FEATURE_THRESHOLD: "0.8"
      IMPORTANT_FEATURES: "event_type_purchase,event_type_signup"
      # Sinks
      USE_REDIS: "1"
      REDIS_URL: redis://redis:6379/0
      USE_PG: "1"
      PG_DSN: postgresql+psycopg2://user:pass@postgres:5432/mlflow_db
      # Metrics
      USE_PROMETHEUS: "1"
      PROM_PORT: "9100"
      # MLflow
      MLFLOW_TRACKING_URI: http://mlflow_server:5000
      MLFLOW_EXPERIMENT_NAME: Phase4_FeatureOrchestrator

  router_worker:
    build: ../src/router_worker
    container_name: router_worker
    environment:
      KAFKA_BROKERS: kafka:9092
      IN_TOPIC: user_events
      FAST_TOPIC: events.low_latency
      BATCH_TOPIC: events.batch
      GROUP_ID: router_worker_v1
      ROUTER_URL: http://router:7000/score
      BATCH_SIZE: "64"
      BATCH_TIMEOUT: "0.8"
      USE_REDIS: "1"
      REDIS_URL: redis://redis:6379/0
      USE_PG: "1"
      PG_DSN: postgresql+psycopg2://user:pass@postgres:5432/mlflow_db
    depends_on:
      - kafka
      - router
      - redis
      - postgres

  router:
    build: ../src/router
    container_name: router
    environment:
      MLFLOW_TRACKING_URI: http://mlflow_server:5000
      MLFLOW_REGISTRY_URI: http://mlflow_server:5000
      MODEL_NAME: event_classifier
      MODEL_ALIAS: staging
      SERVE_URL: http://model_server:6000/invocations
      ROUTING_THRESHOLD: "0.6"
      TOP_K: "5"
      ARTIFACT_LOCAL_ROOT: /mlflow/mlruns
      # Optional sinks:
      USE_REDIS: "0"     # set "1" to enable
      USE_PG: "1"        # set "1" to enable
      REDIS_URL: redis://redis:6379/0
      PG_DSN: postgresql+psycopg2://user:pass@postgres:5432/mlflow_db
      USE_RL: "0"
      RL_DECIDER_URL: "http://rl_decider:8080/route"
    depends_on:
      - mlflow
      - model_server
    ports:
      - "7000:7000"
    volumes:
      - D:/Project/AIEO/mlruns:/mlflow/mlruns 

  model_server:
    build: ../src/ml_training            
    container_name: model_server
    environment:
      MLFLOW_TRACKING_URI: http://mlflow_server:5000
      MLFLOW_REGISTRY_URI: http://mlflow_server:5000
    depends_on:
      - mlflow
    command: >
      mlflow models serve
      -m models:/event_classifier@staging
      --env-manager local
      --host 0.0.0.0
      --port 6000
    ports:
      - "6000:6000"

  ml_training:
    build:
      context: ../src/ml_training
      dockerfile: Dockerfile
    container_name: ml_training
    depends_on:
      - postgres
      - mlflow
    environment:
      MLFLOW_TRACKING_URI: http://mlflow_server:5000
      MLFLOW_EXPERIMENT_NAME: Phase2_Experiment_v2
      POSTGRES_HOST: postgres
      POSTGRES_DB: mlflow_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      POSTGRES_PORT: "5432"
  postgres:
    image: postgres:latest
    container_name: postgres
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: mlflow_db
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:latest
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  zookeeper:
    image: zookeeper:3.9.2
    container_name: zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOO_4LW_COMMANDS_WHITELIST: "stat, ruok, conf, cons, isro, isrover, srvr, wchc, wchp, get, set, del, sync, kill"
      ZOO_TICK_TIME: 2000
      ZOO_INIT_LIMIT: 10
      ZOO_SYNC_LIMIT: 5

  kafka:
    image: wurstmeister/kafka:latest
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://host.docker.internal:9092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    depends_on:
      - zookeeper
    volumes:
      - kafka_data:/kafka

  event_generator:
    build: ../src/event_generator
    container_name: event_generator
    depends_on:
      - kafka
    environment:
      - EVENT_RATE=1000
      - PYTHONUNBUFFERED=1

  event_ingestor:
    build: ../src/event_ingestor
    container_name: event_ingestor
    depends_on:
      - kafka
      - redis
      - postgres
    environment:
      - PYTHONUNBUFFERED=1

  mlflow:
    image: ghcr.io/mlflow/mlflow
    container_name: mlflow_server
    ports:
      - "5000:5000"
    environment:
      BACKEND_STORE_URI: postgresql://user:pass@postgres:5432/mlflow_db
      MLFLOW_ARTIFACTS_DESTINATION: file:/mlflow/mlruns
    volumes:
      - D:/Project/AIEO/mlruns:/mlflow/mlruns
    depends_on:
      - postgres
    command: >
      mlflow server
      --host 0.0.0.0
      --port 5000
      --backend-store-uri $${BACKEND_STORE_URI}
      --artifacts-destination $${MLFLOW_ARTIFACTS_DESTINATION}

volumes:
  pgdata:
    driver: local
    driver_opts:
      type: none
      device: D:/Project/AIEO/pgdata
      o: bind
  redis_data:
    driver: local
    driver_opts:
      type: none
      device: D:/Project/AIEO/redis_data
      o: bind
  kafka_data:
    driver: local
    driver_opts:
      type: none
      device: D:/Project/AIEO/kafka_data
      o: bind
  mlflow_artifacts:
    driver: local
    driver_opts:
      type: none
      device: D:/Project/AIEO/mlflow
      o: bind
